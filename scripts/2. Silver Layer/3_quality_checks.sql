/*
===============================================================================
Quality Checks
===============================================================================

Script Purpose:
This script performs various quality checks for data consistency, accuracy,
and standardization across the 'silver' schemas. It includes checks for:
- Null or duplicate primary keys.
- Unwanted spaces in string fields.
- Data standardization and consistency.
- Invalid date ranges and orders.
- Data consistency between related fields.

Usage Notes:
- Run these checks after data loading Silver Layer.
- Investigate and resolve any discrepancies found duriathe checks.

===============================================================================

*/





/* =========================================================== crm_cust_info Before ================================================================ */

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select 
	bronze.crm_cust_info.cst_id ,
	count(*) 
from 
	bronze.crm_cust_info

group by
	cst_id

Having 
	count(*) > 1 or cst_id is null ;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Unwanted Spaces
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------


select * from bronze.crm_cust_info

where
	cst_firstname != TRIM(cst_firstname) ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Data Standardization & Consistency
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select distinct cst_gndr from bronze.crm_cust_info ;

select distinct cst_marital_status from bronze.crm_cust_info ;



-------------------------------------------------------------------------------------------------------------------------------------------------------

/* =========================================================== crm_prd_info  Before ================================================================ */

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Duplicate Records
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------

select
	bronze.crm_prd_info.prd_id ,
	count(*)

from
	bronze.crm_prd_info

group by
	prd_id

Having 
	count(*) > 1 or prd_id is null ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Unwanted Spaces
-- Expectation : No Result
-------------------------------------------------------------------------------------------------------------------------------------------------------


select * from bronze.crm_prd_info

where
	crm_prd_info.prd_nm != TRIM(crm_prd_info.prd_nm) ;

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out for Nulls and Negative Records
-------------------------------------------------------------------------------------------------------------------------------------------------------

select *

from
	bronze.crm_prd_info

where
	bronze.crm_prd_info.prd_cost < 0 or prd_cost is null ;
	

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check out Data Standardization & Consistency
-------------------------------------------------------------------------------------------------------------------------------------------------------


select 
	distinct prd_line

from
	bronze.crm_prd_info ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Invalid Dates
-------------------------------------------------------------------------------------------------------------------------------------------------------

select * 

from 
	bronze.crm_prd_info

where
	prd_start_dt > prd_end_dt ;


/* ================================================= Sales Details Table Before ================================================================ */

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Unwanted Spaces 
-- Check for Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------


select *
	
from
	bronze.crm_sales_details

where
	sls_ord_num != trim(sls_ord_num) OR sls_cust_id not in (select cst_id from silver.crm_cust_info)  ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Invalied Dates
-------------------------------------------------------------------------------------------------------------------------------------------------------

select 
	
	distinct NULLIF(sls_order_dt , 0)	
	

from
	bronze.crm_sales_details 

where
	sls_order_dt <= 0 
	or len(sls_order_dt) != 8
	or sls_order_dt > 20500101
	or sls_order_dt < 19000101 ;


-- NB : sls_ship_dt and sls_due_dt are cleaner without further issues


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Invalied Dates Order
-------------------------------------------------------------------------------------------------------------------------------------------------------


select *

from
	bronze.crm_sales_details

where
	sls_order_dt > sls_ship_dt ;



-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Consistency ; Sales , Quantity , and Pricing 
-- Sales = Quantity * Price
-- Values must not be zero , negative or null
-------------------------------------------------------------------------------------------------------------------------------------------------------


select distinct
	sls_sales ,
	sls_price as old_price,
	sls_quantity ,

	case 
		when sls_sales is null or sls_sales <= 0 or sls_sales != sls_quantity * abs(sls_price)
			then sls_quantity * sls_price
		else sls_sales
	end as sls_sales ,

	case 
		when sls_price is null or sls_price <= 0
			then sls_sales /  NULLIF(sls_quantity , 0 )
		else sls_price
	end as sls_price

from
	bronze.crm_sales_details

where
	sls_sales !=  sls_price * sls_quantity
	or sls_sales Is Null or sls_price Is Null or sls_quantity Is Null
	or sls_sales <= 0 or sls_price <= 0 or sls_quantity <=0

order by
	sls_sales ,
	sls_price ,
	sls_quantity	;


/* ================================================= Erp_cust_az12 Table Before ================================================================ */

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------

select * 

from 
	bronze.erp_cust_az12 

where
	cid not in (select crm_cust_info.cst_key from silver.crm_cust_info) ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Out Range Dates
-------------------------------------------------------------------------------------------------------------------------------------------------------


select
	bdate

from
	bronze.erp_cust_az12 

where
	bdate < '1924-01-01' or  bdate > GETDATE() ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check all possible gender value
-------------------------------------------------------------------------------------------------------------------------------------------------------

select distinct bronze.erp_cust_az12.gen  from bronze.erp_cust_az12 ;


/* ================================================= Erp_loc_a101 Table Before ================================================================ */


select distinct *  from bronze.erp_loc_a101 ;


-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Integrity
-------------------------------------------------------------------------------------------------------------------------------------------------------

select 
  cst_key 
from 
  bronze.crm_cust_info 
where 
  cst_key not in ( select  cid from  bronze.erp_loc_a101  );
       
    

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Consistency
-------------------------------------------------------------------------------------------------------------------------------------------------------
   
select  
	distinct cntry as old_cntry 
from 
	bronze.erp_loc_a101 ;



/* ================================================= Erp_px_cat_g1v2 Table Before ================================================================ */

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Unwanted Spaces
-------------------------------------------------------------------------------------------------------------------------------------------------------
   

select
	*
from
	bronze.erp_px_cat_g1v2

where
	cat != trim(cat) or subcat != trim(subcat) or maintenance != trim(maintenance);

-------------------------------------------------------------------------------------------------------------------------------------------------------
-- Check for Data Standarization
-------------------------------------------------------------------------------------------------------------------------------------------------------
   
select distinct cat from  bronze.erp_px_cat_g1v2 ;

select distinct subcat from  bronze.erp_px_cat_g1v2 ;

select distinct maintenance from  bronze.erp_px_cat_g1v2 ;
